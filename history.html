<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿‡å¾€å†å²</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* å†å²é¡µé¢ç‰¹å®šæ ·å¼ */
        .history-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .history-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .history-title {
            font-size: 28px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .control-options {
            display: flex;
            gap: 15px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
        }
        
        .collect-toggle, .sort-toggle {
            padding: 8px 16px;
            border: 2px solid #6c757d;
            background: transparent;
            color: #6c757d;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .collect-toggle:hover, .sort-toggle:hover {
            background: #6c757d;
            color: white;
        }
        
        .collect-toggle.active {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }
        
        .collect-toggle.active .toggle-icon {
            color: #ffc107;
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .history-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #e0e0e0;
        }
        
        .history-item-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .history-item-actions {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .collected-icon {
                font-size: 14px;
                opacity: 0.7;
                transition: opacity 0.2s ease;
            }
            
            .collect-toggle-btn {
                background: none;
                border: none;
                cursor: pointer;
                padding: 4px;
                border-radius: 50%;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 24px;
                height: 24px;
            }
            
            .collect-toggle-btn:hover {
                background: rgba(0, 0, 0, 0.1);
                transform: scale(1.1);
            }
            
            .collect-toggle-btn:active {
                transform: scale(0.95);
            }
        
        .history-type {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .history-type.plum-blossom {
            background: #e74c3c;
        }
        
        .history-time {
            color: #666;
            font-size: 14px;
        }
        
        .history-question {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .history-answer {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            color: #555;
            line-height: 1.6;
            font-style: italic;
        }
        
        .no-history {
            text-align: center;
            color: #999;
            padding: 60px 20px;
            font-size: 16px;
        }
        
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            color: #667eea;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            color: #999;
            text-align: center;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .empty-subtext {
            font-size: 14px;
            color: #bbb;
        }
    </style>
</head>
<body>
    <div class="history-page">
        <button class="back-btn" onclick="window.location.href='index.html'">â† è¿”å›ä¸»é¡µ</button>
        
        <div class="history-container">
            <div class="history-header">
                <h1 class="history-title">è¿‡å¾€å†å²</h1>
                <div class="header-controls">
                    <div class="control-options">
                        <div class="control-group">
                            <button class="collect-toggle" id="collectToggle">
                                <span class="toggle-icon">â™¡</span>
                                <span class="toggle-text">ä»…æ˜¾ç¤ºæ”¶è—</span>
                            </button>
                        </div>
                        <div class="control-group">
                            <button class="sort-toggle" id="sortToggle">
                                <span class="toggle-icon">â†•</span>
                                <span class="toggle-text">æœ€æ–°åœ¨å‰</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="history-list" id="historyList">
                <!-- å†å²è®°å½•å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <script>
        class HistoryManager {
            constructor() {
                this.historyData = this.loadHistoryData();
                this.currentSort = 'newest';
                this.currentFilter = 'all'; // all æˆ– collected
                this.collections = this.loadCollectionsData();
                this.initEventListeners();
                this.renderHistory();
            }
            
            // ä»localStorageåŠ è½½å†å²æ•°æ®
            loadHistoryData() {
                const history = localStorage.getItem('app_history') || '[]';
                const historyArray = JSON.parse(history);
                
                // å¦‚æœæ²¡æœ‰å†å²æ•°æ®ï¼Œæ·»åŠ ä¸€äº›ç¤ºä¾‹æ•°æ®
                if (historyArray.length === 0) {
                    const sampleHistory = [
                        {
                            id: 1,
                            type: 'æ„Ÿåº”ç­”æ¡ˆ',
                            question: 'æ˜¯å¦åº”è¯¥æ¥å—è¿™ä¸ªæ–°çš„å·¥ä½œæœºä¼šï¼Ÿ',
                            answer: 'æ¯ä¸€ä¸ªé€‰æ‹©éƒ½æ˜¯å†…å¿ƒæˆé•¿çš„æœºä¼šã€‚ç›¸ä¿¡è‡ªå·±çš„ç›´è§‰ï¼Œå®ƒä¼šå¼•å¯¼ä½ èµ°å‘æœ€é€‚åˆçš„é“è·¯ã€‚å‹‡æ•¢åœ°è¸å‡ºèˆ’é€‚åœˆï¼Œæ–°çš„æŒ‘æˆ˜å°†å¸¦æ¥æ„æƒ³ä¸åˆ°çš„æ”¶è·ã€‚',
                            time: '2024-11-13 14:30:25',
                            scene: 'job',
                            timestamp: 1702541425000
                        },
                        {
                            id: 2,
                            type: 'æ¢…èŠ±æ˜“æ•°',
                            question: 'æ„Ÿæƒ…çš„æœªæ¥å‘å±•å¦‚ä½•ï¼Ÿ',
                            answer: 'æ„Ÿæƒ…ä¹‹äº‹å¦‚æµæ°´ï¼Œé¡ºå…¶è‡ªç„¶æ–¹å¾—å§‹ç»ˆã€‚å½“å‰è™½æœ‰æ³¢æ¾œï¼Œä½†è‹¥ä»¥è¯šå¾…äººï¼Œä»¥å¿ƒæ¢å¿ƒï¼Œå¿…èƒ½åŒ–è§£è¯¯ä¼šï¼Œé‡å½’äºå¥½ã€‚',
                            time: '2024-11-12 16:45:10',
                            scene: 'love',
                            timestamp: 1702457110000,
                            randomNumber: '589',
                            eventTime: '2024-11-12 16:30:00'
                        },
                        {
                            id: 3,
                            type: 'æ„Ÿåº”ç­”æ¡ˆ',
                            question: 'ä»Šå¤©é€‚åˆæ¬å®¶å—ï¼Ÿ',
                            answer: 'æ—¶æœºå·²è‡³ï¼Œä¸è¦å†çŠ¹è±«ã€‚æ–°çš„ç¯å¢ƒå°†å¸¦æ¥æ–°çš„æœºé‡ï¼Œè™½ç„¶é€‚åº”éœ€è¦æ—¶é—´ï¼Œä½†è¿™æ­£æ˜¯æˆé•¿çš„æ—¶å€™ã€‚ç›¸ä¿¡è‡ªå·±çš„åˆ¤æ–­ï¼Œè¡ŒåŠ¨å§ã€‚',
                            time: '2024-11-11 10:15:33',
                            scene: 'daily',
                            timestamp: 1702347333000
                        }
                    ];
                    
                    this.saveHistoryData(sampleHistory);
                    return sampleHistory;
                }
                
                return historyArray;
            }
            
            // ä¿å­˜å†å²æ•°æ®åˆ°localStorage
            saveHistoryData(data) {
                localStorage.setItem('app_history', JSON.stringify(data));
            }
            
            // åŠ è½½æ”¶è—æ•°æ®
            loadCollectionsData() {
                const collections = localStorage.getItem('collections') || '[]';
                return JSON.parse(collections);
            }
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            initEventListeners() {
                // æ”¶è—ç­›é€‰å¼€å…³
                const collectToggle = document.getElementById('collectToggle');
                if (collectToggle) {
                    collectToggle.addEventListener('click', () => {
                        if (this.currentFilter === 'collected') {
                            this.currentFilter = 'all';
                            collectToggle.classList.remove('active');
                        } else {
                            this.currentFilter = 'collected';
                            collectToggle.classList.add('active');
                        }
                        this.renderHistory();
                    });
                }
                
                // æ’åºåˆ‡æ¢
                const sortToggle = document.getElementById('sortToggle');
                if (sortToggle) {
                    sortToggle.addEventListener('click', () => {
                        const textEl = sortToggle.querySelector('.toggle-text');
                        if (this.currentSort === 'newest') {
                            this.currentSort = 'oldest';
                            if (textEl) textEl.textContent = 'æœ€æ—§åœ¨å‰';
                        } else {
                            this.currentSort = 'newest';
                            if (textEl) textEl.textContent = 'æœ€æ–°åœ¨å‰';
                        }
                        this.renderHistory();
                    });
                }
                
                // æ”¶è—åˆ‡æ¢æŒ‰é’®äº‹ä»¶ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.collect-toggle-btn')) {
                        const btn = e.target.closest('.collect-toggle-btn');
                        const question = btn.dataset.question;
                        const answer = btn.dataset.answer;
                        this.toggleHistoryItemCollection(question, answer);
                    }
                });
            }
            
            // æ£€æŸ¥å†å²è®°å½•æ˜¯å¦è¢«æ”¶è—
            isHistoryCollected(historyItem) {
                return this.collections.some(collection => 
                    collection.question === historyItem.question && 
                    collection.answer === historyItem.answer
                );
            }
            
            // åˆ‡æ¢å†å²é¡¹ç›®çš„æ”¶è—çŠ¶æ€
            toggleHistoryItemCollection(question, answer) {
                const questionDecode = decodeURIComponent(question);
                const answerDecode = decodeURIComponent(answer);
                
                const existingIndex = this.collections.findIndex(collection => 
                    collection.question === questionDecode && 
                    collection.answer === answerDecode
                );
                
                if (existingIndex !== -1) {
                    // å·²æ”¶è—ï¼Œç§»é™¤
                    this.collections.splice(existingIndex, 1);
                } else {
                    // æœªæ”¶è—ï¼Œæ·»åŠ 
                    this.collections.push({
                        question: questionDecode,
                        answer: answerDecode,
                        type: this.historyData.find(item => 
                            item.question === questionDecode && item.answer === answerDecode
                        )?.type || 'æ„Ÿåº”ç­”æ¡ˆ',
                        timestamp: Date.now()
                    });
                }
                
                // ä¿å­˜æ”¶è—æ•°æ®
                localStorage.setItem('collections', JSON.stringify(this.collections));
                
                // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°UI
                this.renderHistory();
            }
            
            // æ¸²æŸ“å†å²è®°å½•
            renderHistory() {
                const historyList = document.getElementById('historyList');
                
                if (this.historyData.length === 0) {
                    historyList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“–</div>
                            <div class="empty-text">æš‚æ— å†å²è®°å½•</div>
                            <div class="empty-subtext">å¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡å åœå§</div>
                        </div>
                    `;
                    return;
                }
                
                // é¦–å…ˆæ ¹æ®è¿‡æ»¤æ¡ä»¶ç­›é€‰æ•°æ®
                let filteredData = [...this.historyData];
                if (this.currentFilter === 'collected') {
                    filteredData = filteredData.filter(item => this.isHistoryCollected(item));
                }
                
                // å¦‚æœè¿‡æ»¤åæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                if (filteredData.length === 0) {
                    const emptyMessage = this.currentFilter === 'collected' ? 
                        'æš‚æ— æ”¶è—çš„è®°å½•' : 'æš‚æ— å†å²è®°å½•';
                    const emptySubtext = this.currentFilter === 'collected' ? 
                        'å¿«å»æ”¶è—ä¸€äº›é‡è¦çš„å¯ç¤ºå§' : 'å¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡å åœå§';
                    
                    historyList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“–</div>
                            <div class="empty-text">${emptyMessage}</div>
                            <div class="empty-subtext">${emptySubtext}</div>
                        </div>
                    `;
                    return;
                }
                
                // æ ¹æ®å½“å‰æ’åºæ–¹å¼æ’åºæ•°æ®
                const sortedData = [...filteredData].sort((a, b) => {
                    if (this.currentSort === 'newest') {
                        return b.timestamp - a.timestamp;
                    } else {
                        return a.timestamp - b.timestamp;
                    }
                });
                
                // ç”ŸæˆHTML
                const historyHTML = sortedData.map(item => {
                    const isPlumBlossom = item.type === 'æ¢…èŠ±æ˜“æ•°';
                    const typeClass = isPlumBlossom ? 'plum-blossom' : '';
                    const extraInfo = isPlumBlossom && item.randomNumber ? 
                        `<div class="extra-info">éšæœºæ•°: ${item.randomNumber}</div>` : '';
                    const isCollected = this.isHistoryCollected(item);
                    const collectedIcon = isCollected ? 'â¤ï¸' : 'ğŸ¤';
                    const collectedTitle = isCollected ? 'å–æ¶ˆæ”¶è—' : 'æ·»åŠ æ”¶è—';
                    
                    return `
                        <div class="history-item" data-id="${item.id}">
                            <div class="history-item-header">
                                <span class="history-type ${typeClass}">${item.type}</span>
                                <div class="history-item-actions">
                                    <button class="collect-toggle-btn" 
                                            data-question="${encodeURIComponent(item.question)}" 
                                            data-answer="${encodeURIComponent(item.answer)}"
                                            title="${collectedTitle}">
                                        <span class="collected-icon">${collectedIcon}</span>
                                    </button>
                                    <span class="history-time">${item.time}</span>
                                </div>
                            </div>
                            <div class="history-question">${item.question}</div>
                            <div class="history-answer">${item.answer}</div>
                            ${extraInfo}
                        </div>
                    `;
                }).join('');
                
                historyList.innerHTML = historyHTML;
            }
            
            // æ·»åŠ æ–°çš„å†å²è®°å½•
            addHistoryRecord(type, question, answer, scene, additionalData = {}) {
                const newRecord = {
                    id: Date.now(),
                    type: type,
                    question: question,
                    answer: answer,
                    time: new Date().toLocaleString(),
                    scene: scene,
                    timestamp: Date.now(),
                    ...additionalData
                };
                
                this.historyData.unshift(newRecord);
                this.saveHistoryData(this.historyData);
                this.renderHistory();
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å†å²ç®¡ç†å™¨
        document.addEventListener('DOMContentLoaded', () => {
            window.historyManager = new HistoryManager();
        });
        
        // æ¨¡æ‹Ÿä»ä¸»é¡µæ·»åŠ å†å²è®°å½•çš„å‡½æ•°
        function addHistoryRecord(type, question, answer, scene, additionalData = {}) {
            if (window.historyManager) {
                window.historyManager.addHistoryRecord(type, question, answer, scene, additionalData);
            }
        }
        
        // æš´éœ²åˆ°å…¨å±€ï¼Œä»¥ä¾¿ä¸»é¡µè°ƒç”¨
        window.addHistoryRecord = addHistoryRecord;
    </script>
</body>
</html>